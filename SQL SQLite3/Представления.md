
**Представление** является виртуальной таблицей. Это просто сохраненный SQLзапрос, который может выполняться многократно или на него (как подзапрос) могут ссылаться другие запросы. Представления полезны, если постоянно требуется один и тот же запрос, особенно когда он сложен. Предположим, руководство компании sTunes запрашивает одни и те же данные о продажах каждую неделю или квартал. Значит, имеет смысл подготовить представление — запрос на искомую информацию. Рассмотрим варианты использования представлений в SQL.


## Работа с представлениями

Все операторы SQL, показанные в предыдущих главах, можно сохранить и использовать повторно, когда нам потребуется создать представление. Рассмотрим запрос, показанный в начале главы 8.

`SELECT`
	`round(avg(total), 2) as [Average Total]`
`FROM`
	`invoices`

Мы можем преобразовать этот оператор в представление, добавив над верхней строкой запроса команду `CREATE VIEW V_AvgTotal AS`:

`CREATE VIEW V_AvgTotal AS`
`SELECT`
	`round(avg(total), 2) AS [Average Total]`
`FROM`
	`invoices`

Итак, мы создали представление` V_AvgTotal`.

**ПРИМЕЧАНИЕ**
**При именовании представлений используется `V_` в начале названия. После символа подчеркивания идет краткое описание того, как работает представление, при этом при необходимости используются дополнительные символы подчеркивания. Также можно назвать это представление `V_AvgTotal_Rounded`. Вы можете выбрать другое название.**

При выполнении этого оператора мы получим следующее сообщение: Query executed successfully `CREATE VIEW V_AvgTotal` AS (Запрос успешно выполнен: `CREATE VIEW V_AvgTotal AS`). Представление `V_AvgTotal` можно увидеть в разделе Views (Представления) на вкладке Database Structure (Структура базы данных) в DB Browser.


## Использование представлений

Использование представлений в базах данных полезно по ряду причин, но в первую очередь из-за удобства. Если вам постоянно нужен один и тот же запрос или вы постоянно ссылаетесь на конкретное соединение, которое показывает взаимодействие двух таблиц, такой запрос удобно сохранить как представление, и тогда он будет доступен при необходимости в любое время. Кроме того, когда запрос сохраняется как представление, его можно вызвать как подзапрос, выбрав имя представления.

Рассмотрим представление `V_AvgTotal`, созданное в начале этой главы. В главе 8 для сравнения итоговых сумм счетов со средней суммой счета мы использовали функцию расчета среднего значения в качестве подзапроса. Теперь, чтобы не писать полный подзапрос расчета среднего значения, мы можем написать наш запрос следующим образом:

`SELECT`
	`InvoiceDate,`
	`BillingAddress,`
	`BillingCity,`
	`total`
`FROM`
	`invoices`
`WHERE total <` 
	`(select` 
		`*`
	`from` 
		`V_AvgTotal)`
`ORDER BY`
	`total DESC`

**ПРИМЕЧАНИЕ**
**Хотя представление — это полноценный SQL-запрос, мы все равно должны ссылаться на него в операторе `SELECT`, если будем использовать представление вместе с подзапросами. В операторах `SELECT` можно использовать символ *, чтобы представление, на которое мы ссылаемся, возвращало все строки. В рассматриваемом примере строка только одна — агрегированная сумма.**



## Изменения представлений

Как мы упоминали ранее, текущая версия DB Browser (на момент написания этой книги) не поддерживает изменение существующих представлений. В качестве альтернативы в SQLite необходимо создать новое представление и присвоить ему новое имя или удалить существующее представление. Чтобы изменить представление в SQLite, необходимо перейти на вкладку Execute SQL (Выполнить SQL-запрос), щелкнуть правой кнопкой мыши на представлении и скопировать оператор `CREATE VIEW`. Затем можно вставить результаты

**ПРИМЕЧАНИЕ**
**При повторном запуске представления, если исходное представление все еще сохранено в разделе Views (Представления), необходимо переименовать новое представление (или удалить существующее). Иначе появится сообщение об ошибке, указывающее, что представление уже существует. Имя представления должно быть уникальным.**


## Соединенные представления

Представления очень полезны для хранения длинных или сложных запросов. В главе 6 мы рассказывали о соединениях. Соединения помогают создавать связи между таблицами, обычно это довольно длинные запросы, поэтому их можно сохранить в качестве представлений, чтобы не вводить заново. В последней главе, посвященной подзапросам, мы использовали вместе таблицы `invoice_items` и `tracks`, чтобы выяснить, какие песни из таблицы tracks никогда не были заказаны. Нам бы пригодилось представление, связывающее эти две таблицы. На него можно было бы ссылаться в подзапросе либо просто сохранить как представление, чтобы использовать при необходимости.

Чтобы создать представление для этих двух таблиц, сначала необходимо решить, какое соединение мы хотим использовать. Поскольку мы ищем коррелирующие поля, то будем использовать условие `INNER JOIN` для таблиц `invoice_items` и `tracks`.

`SELECT`
	`ii.InvoiceId,`
	`ii.UnitPrice,`
	`ii.Quantity,`
	`t.name,`
	`t.Composer,`
	`t.Milliseconds`
`FROM`
	`invoice_items ii`
`INNER JOIN`
	`tracks t`
`ON ii.TrackId = t.TrackId`

**НАПОМИНАНИЕ**
**При создании соединения для каждой таблицы мы используем короткие псевдонимы, а затем, выявив общее поле, связываем таблицы друг с другом. В нашем случае зададим t для таблицы tracks и ii для таблицы `invoice_items`, так как i уже используется для таблицы `invoices`.**

Теперь, когда соединение создано, мы можем добавить еще одну строку в начало запроса, чтобы сохранить его как представление.

`CREATE VIEW V_Tracks_InvoiceItems AS`
`SELECT`
	`ii.InvoiceId,`
	`ii.UnitPrice,`
	`ii.Quantity,`
	`t.name,`
	`t.Composer,`
	`t.Milliseconds`
`FROM`
	`invoice_items ii`
`INNER JOIN`
	`tracks t`
`ON ii.TrackId = t.TrackId`

Теперь возьмем из главы 6 соединение, объединяющее таблицы invoices, customers и employees, и сохраним как представление.

`CREATE VIEW V_inv_cus_emp AS`
`SELECT`
	`i.InvoiceId,`
	`i.InvoiceDate,`
	`i.total,`
	`i.CustomerId,`
	`c.FirstName,`
	`c.LastName,`
	`c.SupportRepId,`
	`e.EmployeeId,`
	`e.LastName,`
	`e.FirstName,`
	`e.Title`
`FROM`
	`invoices AS i`
`INNER JOIN`
	`customers AS c`
`ON`
	`i.CustomerId = c.CustomerId`
`INNER JOIN`
	`employees AS e`
`ON`
	`e.EmployeeId = c.SupportRepId`
`ORDER BY`
	`InvoiceDate`

**ПРИМЕЧАНИЕ**
**В главе 6 мы немного изменили это соединение. Из условия `SELECT` мы удалили символ *. Смысл представлений — показать именно то, что необходимо. Таким образом, мы включили только необходимые поля из таблиц `invoices`, `customers` и `employees`.**

Теперь, когда у нас имеются эти два представления, мы используем их во внутреннем соединении:

`SELECT`
	`*`
`FROM`
	`V_Tracks_InvoiceItems ii` 
`INNER JOIN`
	`V_inv_cus_emp ice`
`ON`
	`ii.InvoiceId = ice.InvoiceId`

С помощью приведенного выше запроса, объединяющего пять таблиц, мы можем узнать, какие треки были проданы каждым сотрудником и какому клиенту. Агрегируя данные, мы также определим, какой трек продавался лучше всего, какой общий доход был получен от продажи трека, а также информацию о сотрудниках, осуществивших продажи. Теперь мы можем при желании сохранить это объединение как представление.

**ПРИМЕЧАНИЕ**
**Соединенные представления будут работать только в том случае, если ключевые поля, общие для всех этих таблиц, были включены в первоначальное соединение.**


## Удаление представлений с помощью оператора DROP

Ранее мы уже описали один способ удаления представления — щелчок правой кнопкой мыши по имени представления на вкладке Database Structure (Структура базы данных). Представление также можно удалить с помощью команды DROP. Это выглядит следующим образом:

`DROP VIEW`
	`V_AvgTotal`

Она удалит представление `V_AvgTotal`. Из базы данных удаляется только представление — синтаксис DROP VIEW не влияет на данные.

**ПРИМЕЧАНИЕ**
**Если вы удалите представление, на которое ссылаются другие представления, эти представления больше не будут работать.**

**ВНИМАНИЕ**
**`DROP` — это команда для удаления любых элементов. Она может также удалить из базы данных таблицу. В следующей главе вы изучите инструменты, с помощью которых можно редактировать или удалять данные без возможности восстановления. Как вы уже знаете, представление также можно удалить из базы данных, щелкнув по нему правой кнопкой мыши и выбрав опцию Remove View (Удалить представление).**

