---
title: Ограничитель трафика
date of creation: 2025-05-30T16:34:00
tags:
  - Web
  - IT
  - IT/WEB
  - Terminology
  - Web/Terminology
  - SystemDesign
read status: true
completion status: true
aliases:
---
# Ограничитель трафика
---

**Ограничитель трафика** используется в сетевых системах для управления скоростью передачи данных от клиента или сервиса. В мире [[HTTP]] он ограничивает количество запросов, которые пользователь может отправить за определенный промежуток времени. Если исчерпано максимальное число API-запросов, заданное ограничителем трафика, все последующие вызовы блокируются. Вот несколько примеров:

- [i] пользователь может создать не больше двух сообщений в секунду;
- [i] с одного IP-адреса можно создать не больше 10 учетных записей в день;
- [i] на одном устройстве можно получить не больше 5 наград в неделю.

Но сначала рассмотрим преимущества использования этого компонента в API.

- [i] Предотвращение нехватки ресурсов, вызванной [[DoS-атакой]] (Denial of Service — «отказ в обслуживании»). Почти все [[API]]интерфейсы, предоставляемые крупными технологическими компаниями, накладывают какие-то ограничения на трафик. Например, Twitter ограничивает количество твитов до 300 за 3 часа. API Google Docs имеет по умолчанию следующее ограничение: 300 запросов на чтение в минуту для каждого пользователя. Ограничитель трафика предотвращает как спланированные, так и непредумышленные [[DoS-атаки]], блокируя избыточные вызовы.
- [i] Экономия бюджета. Ограничение избыточных запросов позволяет освободить часть серверов и выделить больше ресурсов для высоко-приоритетных API. Это чрезвычайно важно для компаний, которые используют платные сторонние API. Например, вам может стоить денег каждое обращение к внешним API, которые позволяют проверить кредитные средства, отправить платеж, получить записи медкарты и т. д. Ограничение количества вызовов играет важную роль в снижении расходов.
- [i] Предотвращение перегрузки серверов. Чтобы снизить нагрузку на серверы, ограничитель трафика фильтрует лишние запросы, исходящие от ботов или недобросовестных пользователей.


## Алгоритмы ограничения трафика
---

Ограничение трафика может быть реализовано с помощью разных алгоритмов, у каждого из которых есть определенные преимущества и недостатки. Но чтобы выбрать алгоритм или сочетание алгоритмов, которые подходят для ваших задач, не помешает иметь о них общее представление. Вот список популярных вариантов:

-  алгоритм маркерной корзины (token bucket);
-  алгоритм дырявого ведра (leaking bucket);
-  счетчик фиксированных интервалов (fixed window counter);
-  журнал скользящих интервалов (sliding window log);
-  счетчик скользящих интервалов (sliding window counter).

### Алгоритм маркерной корзины
---
Алгоритм маркерной корзины довольно популярен. Он простой и понятный, и многие интернет-компании, такие как [[Amazon]] и Stripe, используют его для фильтрации API-запросов.

Алгоритм маркерной корзины работает следующим образом.

- **Маркерная корзина** — это контейнер с заранее определенной емкостью. В нее регулярно помещают маркеры. Когда она окончательно заполняется, маркеры больше не добавляются. Маркерная корзина с емкостью 4. Наполнитель ежесекундно помещает в корзину 2 маркера. Когда корзина заполняется, последующие маркеры отбрасываются.
- Каждый запрос потребляет один маркер. При поступлении запроса мы проверяем, достаточно ли маркеров в корзине.
	- если маркеров достаточно, мы удаляем по одному из них для каждого запроса, и запрос проходит дальше;
	- если маркеров недостаточно, запрос отклоняется.

Алгоритм маркерной корзины принимает два параметра:
- размер корзины: максимальное количество маркеров, которое может в ней находиться;
- частота пополнения: количество маркеров, ежесекундно добавляемых в корзину.

**Преимущества:**

- [p] легкая реализация;
- [p] эффективное потребление памяти;
- [p] маркерная корзина может справиться с короткими всплесками трафика; пока в корзине остаются маркеры, запрос обрабатывается.

**Недостатки:**

- [c] несмотря на то что алгоритм принимает лишь два параметра (размер корзины и частота пополнения), подобрать подходящие значения может быть непросто.


### Алгоритм дырявого ведра
---

Алгоритмы дырявого ведра и маркерной корзины очень похожи, только первый обрабатывает запросы с фиксированной скоростью. Обычно его реализуют с использованием очереди типа [[FIFO]]. Этот алгоритм работает так:

- при поступлении запроса система проверяет, заполнена ли очередь. Запрос добавляется в очередь при наличии места;
- в противном случае запрос отклоняется;
- запросы извлекаются из очереди и обрабатываются через равные промежутки времени.

Алгоритм дырявого ведра принимает два параметра:

- размер ведра: равен размеру очереди; очередь хранит запросы, которые обрабатываются с постоянной скоростью;
- скорость утечки: определяет, сколько запросов можно обработать за определенный промежуток времени (обычно за 1 секунду).

**Преимущества:**

- [p] эффективное потребление памяти при ограниченном размере очереди;
- [p]  запросы обрабатываются с постоянной скоростью, поэтому этот алгоритм подходит для задач, которые требуют стабильной скорости обработки.

**Недостатки:**

- [c] всплеск трафика наполняет очередь старыми запросами, и, если их вовремя не обработать, новые запросы будут отклоняться;
- [c] несмотря на то что алгоритм принимает лишь два параметра, подобрать подходящие значения может быть непросто. 


### Счетчик фиксированных интервалов
---

Счетчик фиксированных интервалов работает так.

- Алгоритм делит заданный период времени на одинаковые интервалы и назначает каждому из них счетчик.
- Каждый запрос инкрементирует счетчик на 1.
- Как только счетчик достигнет заранее заданного лимита, новые запросы начинают отклоняться, пока не начнется следующий интервал.

В качестве интервала выбрана 1 секунда, а система допускает не больше 3 запросов в секунду. На каждом секундном интервале система проверяет количество поступивших запросов и отклоняет лишние.

*Основная проблема этого алгоритма в том, что всплески трафика на границе временных интервалов могут привести к тому, что система может превысить квоту и принять больше запросов.*

**Преимущества:**

- [p] эффективное потребление памяти;
- [p] понятность;
- [p] сброс квоты доступных запросов в конце временного интервала подходит для ряда задач.

**Недостатки:**

- [c] всплески трафика на границе временных интервалов могут привести к приему запросов, количество которых превышает квоту.

